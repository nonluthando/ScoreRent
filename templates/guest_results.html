{% extends "base.html" %}
{% block content %}
<h2>Guest evaluation result</h2>

<div class="result">
  <div class="scoreBox">
    <div class="score">{{ result.score }}</div>
    <div class="verdict">{{ result.verdict }}</div>
    <div class="muted small">Confidence: {{ result.confidence }}</div>
  </div>

  <div class="card">
    <h3>Listing summary</h3>
    <ul class="list">
      <li><strong>Name:</strong> {{ listing.listing_name or "Unnamed listing" }}</li>
      <li><strong>Rent:</strong> R{{ listing.rent }}</li>
      <li><strong>Deposit:</strong> R{{ listing.deposit }}</li>
      <li><strong>Application fee:</strong> R{{ listing.application_fee }}</li>
      <li><strong>Demand:</strong> {{ listing.area_demand }}</li>
    </ul>
  </div>

  <div class="card">
    <h3>Reasons</h3>
    <ul class="list">
      {% for r in result.reasons %}
        <li>{{ r }}</li>
      {% endfor %}
    </ul>
  </div>

  <div class="card">
    <h3>Suggested actions</h3>
    <ul class="list">
      {% for a in result.actions %}
        <li>{{ a }}</li>
      {% endfor %}
    </ul>
  </div>

  <!-- ✅ Breakdown (collapsible + bars) -->
  {% if result.breakdown %}
  <div class="card breakdownCard">
    <details class="breakdownDetails">
      <summary class="breakdownSummary">Show how ScoreRent calculated this score</summary>

      <div class="breakdownList">
        {% for b in result.breakdown %}
          {% set delta = b.delta %}
          {% set before = b.before %}
          {% set after = b.after %}
          {% set title = b.title %}
          {% set details = b.details %}

          {% if delta > 0 %}
            {% set badgeClass = "pos" %}
          {% elif delta < 0 %}
            {% set badgeClass = "neg" %}
          {% else %}
            {% set badgeClass = "zero" %}
          {% endif %}

          <!-- bar = progress between before and after (clamped 0-100) -->
          {% set progress = after %}
          {% if progress < 0 %}{% set progress = 0 %}{% endif %}
          {% if progress > 100 %}{% set progress = 100 %}{% endif %}

          <div class="breakItem">
            <div class="breakTop">
              <div class="breakTitle">{{ title }}</div>

              <div class="breakRight">
                <span class="deltaBadge {{ badgeClass }}">
                  {% if delta > 0 %}+{{ delta }}{% else %}{{ delta }}{% endif %}
                </span>
                <span class="arrowNums">{{ before }} → {{ after }}</span>
              </div>
            </div>

            {% if details %}
              <div class="breakDetailsText">{{ details }}</div>
            {% endif %}

            <div class="miniBar">
              <div class="miniBarFill" style="width: {{ progress }}%"></div>
            </div>
          </div>
        {% endfor %}
      </div>
    </details>
  </div>
  {% endif %}

  <div class="actionsRow">
    <a class="btn" href="/evaluate">Evaluate another</a>
    <a class="btn ghost" href="/signup">Sign up to save history</a>
  </div>
</div>
{% endblock %}
