{% extends "base.html" %}
{% block content %}

<section class="stack" style="padding-top: 26px;">
  <div class="stack" style="gap:10px;">
    <h2>Evaluate listing</h2>
    <p>Enter listing details below. Weâ€™ll calculate confidence + recommend what to do next.</p>
  </div>

  <form method="post" class="card stack">

    {% if not user %}
      <div class="card">
        <h3>Your details (Guest)</h3>
        <p class="muted">Guest evaluations require your renter details so we can score the listing correctly.</p>

        <div class="grid-2">
          <div class="stack">
            <label>Renter type</label>
            <select name="guest_renter_type" id="guest_renter_type">
              <option value="worker">Worker</option>
              <option value="new_professional">New professional</option>
              <option value="student">Student</option>
            </select>
          </div>

          <div class="stack">
            <label>Monthly income / support (R)</label>
            <input name="guest_monthly_income" type="number" min="0" placeholder="e.g. 18000" />
          </div>
        </div>

        <div class="stack" id="bursary_block" style="display:none;">
          <label>Are you a bursary student?</label>
          <select name="student_is_bursary" id="student_is_bursary">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
          <p class="muted small" style="margin-top:-6px;">
            This helps ScoreRent choose the correct student evaluation rules.
          </p>
        </div>

        <div class="stack">
          <label>Documents you have</label>
          <p class="muted" style="margin-top:-6px;">
            Tick what you can provide. ScoreRent uses this to check document fit.
          </p>

          <!-- Worker docs -->
          <div class="checkbox-group" id="docs_worker" style="display:none;">
            {% for doc in (doc_clusters["worker"] | sort) %}
              <label class="checkbox">
                <input type="checkbox" name="guest_renter_docs" value="{{ doc }}" />
                <span>{{ doc.replace("_", " ").title() }}</span>
              </label>
            {% endfor %}
          </div>

          <!-- New professional docs -->
          <div class="checkbox-group" id="docs_new_professional" style="display:none;">
            {% for doc in (doc_clusters["new_professional"] | sort) %}
              <label class="checkbox">
                <input type="checkbox" name="guest_renter_docs" value="{{ doc }}" />
                <span>{{ doc.replace("_", " ").title() }}</span>
              </label>
            {% endfor %}
          </div>

          <!-- Student docs -->
          <div class="checkbox-group" id="docs_student" style="display:none;">
            {% for doc in (doc_clusters["student"] | sort) %}
              <label class="checkbox">
                <input type="checkbox" name="guest_renter_docs" value="{{ doc }}" />
                <span>{{ doc.replace("_", " ").title() }}</span>
              </label>
            {% endfor %}

            <label class="checkbox">
              <input type="checkbox" name="guest_renter_docs" value="guarantor_payslip" />
              <span>Guarantor Payslip</span>
            </label>

            <label class="checkbox">
              <input type="checkbox" name="guest_renter_docs" value="guarantor_bank_statement" />
              <span>Guarantor Bank Statement</span>
            </label>
          </div>
        </div>

        <div class="stack" id="guarantor_block" style="display:none;">
          <label>Guarantor monthly income (R) (optional)</label>
          <input name="guest_guarantor_monthly_income" type="number" min="0" placeholder="e.g. 25000" />
          <p class="muted small" style="margin-top:-6px;">
            Only needed for non-bursary student evaluations.
          </p>
        </div>
      </div>

      <hr />
    {% endif %}

    <div class="grid-2">
      <div class="stack">
        <label>Listing name (optional)</label>
        <input name="listing_name" placeholder="e.g. Gardens Studio" />
      </div>

      <div class="stack">
        <label>Area demand</label>
        <select name="area_demand">
          {% for d in demand_levels %}
            <option value="{{ d }}">{{ d }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <hr />

    <div class="grid-2">
      <div class="stack">
        <label>Monthly rent (R)</label>
        <input name="rent" type="number" required min="0" placeholder="e.g. 7500" />
      </div>

      <div class="stack">
        <label>Deposit (R)</label>
        <input name="deposit" type="number" required min="0" placeholder="e.g. 7500" />
      </div>
    </div>

    <div class="grid-2">
      <div class="stack">
        <label>Application fee (R)</label>
        <input name="application_fee" type="number" required min="0" placeholder="e.g. 250" />
      </div>
    </div>

    <hr />

    <div class="stack">
      <label>Required documents (listing)</label>
      <p style="margin-top:-6px;">
        Tick what the listing requires. ScoreRent will check if your profile matches.
      </p>

      <div class="checkbox-group">
        {% for doc in doc_clusters["worker"] | sort %}
          <label class="checkbox">
            <input type="checkbox" name="required_documents" value="{{ doc }}" />
            <span>{{ doc.replace("_", " ").title() }}</span>
          </label>
        {% endfor %}
      </div>
    </div>

    <hr />

    <div class="actions">
      <button class="btn" type="submit">Evaluate</button>
      {% if not user %}
        <a class="btn secondary" href="/signup">Sign up to save results</a>
      {% endif %}
    </div>
  </form>
</section>

{% if not user %}
<script>
  const renterTypeSelect = document.getElementById("guest_renter_type");
  const bursaryBlock = document.getElementById("bursary_block");
  const bursarySelect = document.getElementById("student_is_bursary");

  const guarantorBlock = document.getElementById("guarantor_block");

  const docsWorker = document.getElementById("docs_worker");
  const docsNewPro = document.getElementById("docs_new_professional");
  const docsStudent = document.getElementById("docs_student");

  function showOnlyDocs(type) {
    if (!docsWorker || !docsNewPro || !docsStudent) return;

    docsWorker.style.display = (type === "worker") ? "grid" : "none";
    docsNewPro.style.display = (type === "new_professional") ? "grid" : "none";
    docsStudent.style.display = (type === "student") ? "grid" : "none";
  }

  function updateGuarantorVisibility() {
    if (!guarantorBlock) return;
    const renterType = renterTypeSelect ? renterTypeSelect.value : "worker";
    const bursary = bursarySelect ? bursarySelect.value : "no";

    const shouldShow = (renterType === "student" && bursary === "no");
    guarantorBlock.style.display = shouldShow ? "block" : "none";
  }

  function updateGuestUI() {
    if (!renterTypeSelect) return;
    const type = renterTypeSelect.value;

    if (bursaryBlock) {
      bursaryBlock.style.display = (type === "student") ? "block" : "none";
    }

    showOnlyDocs(type);
    updateGuarantorVisibility();
  }

  if (renterTypeSelect) {
    renterTypeSelect.addEventListener("change", updateGuestUI);
  }

  if (bursarySelect) {
    bursarySelect.addEventListener("change", updateGuarantorVisibility);
  }

  updateGuestUI();
</script>
{% endif %}

{% endblock %}
